# GitLab CI/CD åˆ©ç”¨åŠ¨æ€æŠ¢å å¼å®ä¾‹æ„å»ºç³»ç»Ÿ

ğŸš€ åˆ©ç”¨é˜¿é‡Œäº‘æŠ¢å å¼å®ä¾‹ï¼ˆSpot Instanceï¼‰å®ç°ä½æˆæœ¬ã€é«˜æ€§èƒ½çš„ GitLab CI/CD æ„å»ºæµæ°´çº¿ã€‚

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®é€šè¿‡ GitLab CI/CD æµæ°´çº¿åŠ¨æ€è°ƒç”¨é˜¿é‡Œäº‘ API åˆ›å»º**æŠ¢å å¼å®ä¾‹ï¼ˆSpot Instanceï¼‰**ï¼Œåœ¨åˆ›å»ºçš„å®ä¾‹ä¸­æ‰§è¡Œä»£ç æ„å»ºä¸éƒ¨ç½²ä»»åŠ¡ã€‚æ„å»ºå®Œæˆåè‡ªåŠ¨é‡Šæ”¾å®ä¾‹ï¼Œå®ç°èµ„æºæŒ‰éœ€ä½¿ç”¨ã€æˆæœ¬æä½çš„æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²æ–¹æ¡ˆã€‚

> é€‚ç”¨äºæ„å»ºä»»åŠ¡é‡ã€å¯¹æœåŠ¡å™¨æ€§èƒ½è¦æ±‚é«˜ï¼Œä½†å¸Œæœ›æ§åˆ¶åŸºç¡€è®¾æ–½æˆæœ¬çš„å›¢é˜Ÿã€‚

---
æ ¸å¿ƒç‰¹ç‚¹ï¼š**è½»é‡ GitLab æœåŠ¡ + ä¸´æ—¶æ„å»ºé«˜æ€§èƒ½å®ä¾‹ + è‡ªå®šä¹‰ Runner è°ƒåº¦**
## é¡¹ç›®æˆæœ

åŸå•å°è™šæ‹Ÿæœºæˆæœ¬
<img width="1578" height="656" alt="image" src="https://github.com/user-attachments/assets/c4757a76-2992-45d1-9596-729e605b61b4" />

ä¸€æ¬¡CIæ‰€éœ€æˆæœ¬åœ¨0.02å—ï¼Œå³ä¸¤åˆ†å·¦å³ã€‚ï¼ˆä»¥ä¸€ä¸ªæœˆæ„å»º1000æ¬¡ä¸ºä¾‹ï¼š1000*0.025=25å—é’±ï¼Œä¸€å¹´25*12=300å—ï¼‰ã€‚å¯¹æ¯”ä¹‹å‰å‡†å¤‡ä¸€å° 4æ ¸8G åŒ…å¹´è®¡è´¹å®ä¾‹ï¼Œæˆæœ¬ä¸‹é™åˆ°äº†**1/10**
<img width="1831" height="256" alt="image" src="https://github.com/user-attachments/assets/7e96b927-6a4a-4afa-89c6-2fb5a01bca5d" />

---

## è®¾è®¡æ€è·¯

ä¼ ç»Ÿçš„ GitLab Runner éœ€è¦é•¿æœŸè¿è¡Œåœ¨é«˜é…ç½®æœåŠ¡å™¨ä¸Šï¼Œæˆæœ¬è¾ƒé«˜ï¼Œå¹¶ä¸”å½“å­˜åœ¨ä¸€äº›å¤§å‹ç¼–è¯‘é¡¹ç›®æ—¶ï¼Œå¦‚æœæœºå™¨æ€§èƒ½ä¸è¶³ï¼Œä¼šå¯¼è‡´ç ”å‘èŠ±è´¹å¤§é‡æ—¶é—´ç­‰å¾…æ„å»ºï¼Œæµªè´¹ç”Ÿå‘½ã€‚æœ¬æ–¹æ¡ˆé‡‡ç”¨ä»¥ä¸‹æ¶æ„ï¼š

1. **GitLab CI è§¦å‘æ„å»ºä»»åŠ¡**
2. **Runnerï¼ˆè½»é‡çº§ï¼‰è°ƒç”¨é˜¿é‡Œäº‘ SDK**
3. **åŠ¨æ€åˆ›å»ºä¸€å°æŠ¢å å¼ ECS å®ä¾‹**
4. **åœ¨æ–°å®ä¾‹ä¸­æ‹‰å–ä»£ç ã€æ‰§è¡Œæ„å»ºä¸éƒ¨ç½²**
5. **ä»»åŠ¡å®Œæˆåè‡ªåŠ¨é”€æ¯å®ä¾‹**

GitLab æœ¬ä½“æœåŠ¡å™¨ä»…éœ€æ‰¿æ‹…è°ƒåº¦èŒè´£ï¼Œæ€§èƒ½è¦æ±‚æä½ï¼Œæ‰€æœ‰ç¹é‡çš„æ„å»ºä»»åŠ¡ç”±ä¸´æ—¶é«˜æ€§èƒ½å®ä¾‹å®Œæˆã€‚

---

## æ ¸å¿ƒä¼˜åŠ¿

âœ… **æˆæœ¬æä½**ï¼šæŠ¢å å¼å®ä¾‹ä»·æ ¼å¯ä½è‡³æŒ‰é‡ä»˜è´¹å®ä¾‹çš„ 10%~30%  
âœ… **æ€§èƒ½å¼ºåŠ²**ï¼šå¯é€‰æ‹©é«˜é…å®ä¾‹ï¼ˆå¦‚ 8C16Gã€GPU å®ä¾‹ï¼‰å¿«é€Ÿå®Œæˆæ„å»º  
âœ… **å¼¹æ€§ä¼¸ç¼©**ï¼šæ¯æ¬¡æ„å»ºç‹¬ç«‹è¿è¡Œï¼Œé¿å…èµ„æºäº‰ç”¨  
âœ… **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šåˆ›å»º â†’ æ„å»º â†’ éƒ¨ç½² â†’ é”€æ¯ å…¨æµç¨‹è‡ªåŠ¨åŒ–  
âœ… **è½»é‡ GitLab æœåŠ¡**ï¼šæ— éœ€é«˜é…æœåŠ¡å™¨è¿è¡Œ GitLab å’Œ Runner

---


## ç¯å¢ƒæ„å»ºæ–¹æ³•
### å‡†å¤‡å·¥ä½œï¼š
1. ä¸€å°ç”¨äºæ­å»ºGitlabå’ŒGitlab-runnerçš„å®ä¾‹
2. é˜¿é‡Œäº‘ä¸­å¯ä»¥ç”¨æ¥æ„å»ºå®ä¾‹çš„é•œåƒï¼ˆdockerï¼Œjava23ï¼Œgradleã€kubectlï¼‰
3. ç”¨äºç™»å½•ä¸´æ—¶åˆ›å»ºçš„å®ä¾‹çš„å¯†é’¥å¯¹
### å…·ä½“å®æ“ï¼š
1. æ­å»ºGitLabå’ŒGitlab-runner
  ```version: '3.8'
  services:
    gitlab:
      image: docker.1ms.run/gitlab/gitlab-ce:latest
      container_name: gitlab
      restart: always
      environment:
              GITLAB_OMNIBUS_CONFIG: |
                        external_url 'http://121.41.98.144:8668'
                                gitlab_rails['gitlab_shell_ssh_port'] = 6886
      ports:
        - "8443:443"
        - "8668:8668"
        - "6886:22"
      volumes:
        - /usr/gitlab/config:/etc/gitlab
        - /usr/gitlab/logs:/var/log/gitlab
        - /usr/gitlab/data:/var/opt/gitlab
      shm_size: 256m
    gitlab-runner:
      image: docker.1ms.run/gitlab/gitlab-runner:latest
      container_name: gitlab-runner
      restart: always
      volumes:
        - /usr/gitlab-runner/config:/etc/gitlab-runner
        - /usr/gitlab-runner/script:/usr/gitlab-runner/scripts
        - /var/run/docker.sock:/var/run/docker.sock
      depends_on:
        - gitlab
```
2. åœ¨gitlab-runnerä¸­æ³¨å†Œrunnerï¼ˆæ‰§è¡Œå™¨é€‰å®šcustomè‡ªå®šä¹‰æ‰§è¡Œå™¨ï¼‰
   é…ç½®åçš„runneré…ç½®å¦‚ä¸‹ï¼š<img width="1025" height="808" alt="image" src="https://github.com/user-attachments/assets/69da7b06-2c19-4f58-a5af-18d4167d7627" />
   **æŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºå°†é¡¹ç›®ä¸­ç›¸å…³æ–‡ä»¶æ”¾åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹ã€‚**
3. é¡¹ç›®ä¸­è„šæœ¬ä¸»è¦åŠŸèƒ½
```
   prepare.shï¼š åˆ›å»ºecså®ä¾‹
   
   run.shï¼šå…·ä½“ä¸šåŠ¡é€»è¾‘
   
   cleanup.shï¼šåˆ é™¤åˆ›å»ºçš„ecså®ä¾‹
```   
5. .gitlab-ci.ymlé…ç½®æ ·ä¾‹
   
   <img width="711" height="764" alt="image" src="https://github.com/user-attachments/assets/0250dd46-c999-4720-998c-563274b644bf" />
6. æŒ‰ç…§ä¸Šè¿°é…ç½®å®Œæ¯•ä¹‹åï¼Œè§¦å‘æµæ°´çº¿æ„å»ºå³å¯ã€‚

---


ğŸ’¡ **ç”¨æ›´å°‘çš„æˆæœ¬ï¼Œè·‘æ›´å¿«çš„æ„å»ºï¼**
